name: Airflow ML Pipeline CI/CD

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  AIRFLOW_UID: 50000

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install apache-airflow==2.7.3 pandas scikit-learn numpy pytest

      - name: Lint DAG files
        run: |
          python -c "from airflow.models import DagBag; dagbag = DagBag('dags'); assert len(dagbag.import_errors) == 0, f'DAG import errors: {dagbag.import_errors}'"

      - name: Test DAG integrity
        run: |
          python -c "
          from airflow.models import DagBag
          dagbag = DagBag('dags')
          for dag_id, dag in dagbag.dags.items():
              print(f'Testing DAG: {dag_id}')
              assert dag.task_count > 0, f'{dag_id} has no tasks'
              for task in dag.tasks:
                  print(f'  - Task: {task.task_id}')
          print('All DAGs validated successfully!')
          "

  build:
    needs: test
    runs-on: ubuntu-latest
    if: github.event_name == 'push'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create .env file
        run: |
          echo "AIRFLOW_UID=${{ env.AIRFLOW_UID }}" > .env
          echo "_AIRFLOW_WWW_USER_USERNAME=airflow" >> .env
          echo "_AIRFLOW_WWW_USER_PASSWORD=airflow" >> .env

      - name: Create required directories
        run: |
          mkdir -p logs dags plugins data

      - name: Start Docker Compose services
        run: |
          docker-compose up -d
          echo "Waiting for services to be healthy..."
          sleep 60

      - name: Check services health
        run: |
          docker-compose ps
          docker-compose logs airflow-webserver | tail -20

      - name: Verify Airflow is running
        run: |
          curl -f http://localhost:8080/health || exit 1

      - name: Stop services
        if: always()
        run: docker-compose down -v

  deploy:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy notification
        run: |
          echo "ðŸš€ Deployment to production would happen here"
          echo "ðŸ“¦ Artifacts ready for deployment"
          echo "âœ… CI/CD pipeline completed successfully"

      # Uncomment and configure for actual deployment
      # - name: Deploy to production server
      #   uses: appleboy/ssh-action@v1.0.0
      #   with:
      #     host: ${{ secrets.PROD_HOST }}
      #     username: ${{ secrets.PROD_USER }}
      #     key: ${{ secrets.SSH_PRIVATE_KEY }}
      #     script: |
      #       cd /path/to/airflow-iris-etl
      #       git pull origin main
      #       docker-compose down
      #       docker-compose up -d